{% extends 'tracker/base.html' %} {% block content %}
<div class="py-6">
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8"
  >
    <div>
      <h1
        class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight"
      >
        Expense History
      </h1>
      <p class="mt-1 text-sm text-gray-500 dark:text-slate-400">
        A detailed record of all your transactions
      </p>
    </div>
    <div class="mt-4 sm:mt-0 flex gap-3">
      <button
        onclick="openDownloadModal()"
        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-slate-300 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all"
      >
        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Download Report
      </button>
      <a
        href="{% url 'add_expense' %}"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all"
      >
        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Expense
      </a>
    </div>
  </div>

  <div
    class="bg-white dark:bg-slate-900/40 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden"
  >
    {% if expenses %}
    <!-- Mobile Card View -->
    <div class="md:hidden">
      {% for expense in expenses %}
      <div
        class="p-4 border-b border-gray-100 last:border-0 hover:bg-gray-50 dark:hover:bg-slate-800/40 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <div class="flex flex-col">
            <span class="text-base font-bold text-gray-900 dark:text-white"
              >{{ expense.item }}</span
            >
            <span class="text-xs text-gray-400 dark:text-slate-500 font-medium"
              >{{ expense.created_at|date:"d M Y, h:i A" }}</span
            >
          </div>
          <span class="text-base font-bold text-gray-900 dark:text-white"
            >Rs. {{ expense.amount }}</span
          >
        </div>

        <div class="flex justify-between items-center mt-3">
          <span
            class="px-2.5 py-1 inline-flex text-xs font-semibold rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-800/50"
          >
            {{ expense.category.name|default:"Uncategorized" }}
          </span>

          <div class="flex items-center gap-3">
            <form
              action="{% url 'delete_expense' expense.id %}"
              method="POST"
              onsubmit="
                event.preventDefault();
                openDeleteModal(this);
              "
              class="inline-flex"
            >
              {% csrf_token %}
              <button
                type="submit"
                class="text-gray-400 dark:text-slate-500 hover:text-red-600 transition-colors p-1"
              >
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </form>
          </div>
        </div>

        {% if expense.raw_text %}
        <div
          class="mt-2 text-xs text-gray-500 dark:text-slate-400 bg-gray-50 dark:bg-slate-800/60 rounded-lg italic"
        >
          "{{ expense.raw_text }}"
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Desktop Table View -->
    <div class="hidden md:block overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 dark:bg-slate-800/50">
          <tr>
            <th
              scope="col"
              class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider"
            >
              Date
            </th>
            <th
              scope="col"
              class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider"
            >
              Item Details
            </th>
            <th
              scope="col"
              class="px-6 py-4 text-center text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider"
            >
              Category
            </th>
            <th
              scope="col"
              class="px-6 py-4 text-right text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider"
            >
              Amount
            </th>
            <th
              scope="col"
              class="px-6 py-4 text-right text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody
          class="bg-white dark:bg-transparent divide-y divide-gray-200 dark:divide-slate-800"
        >
          {% for expense in expenses %}
          <tr
            class="hover:bg-gray-50 dark:hover:bg-slate-800/40 transition-colors group"
          >
            <td
              class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400"
            >
              {{ expense.created_at|date:"d M Y, h:i A" }}
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-col">
                <span
                  class="text-sm font-semibold text-gray-900 dark:text-white"
                  >{{ expense.item }}</span
                >
                <span
                  class="text-xs text-gray-400 dark:text-slate-500 mt-1 max-w-md truncate group-hover:whitespace-normal transition-all"
                  >"{{ expense.raw_text }}"</span
                >
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span
                class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-800/50"
              >
                {{ expense.category.name|default:"Uncategorized" }}
              </span>
            </td>
            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900 dark:text-white"
            >
              Rs. {{ expense.amount }}
            </td>
            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
            >
              <form
                action="{% url 'delete_expense' expense.id %}"
                method="POST"
                onsubmit="
                  event.preventDefault();
                  openDeleteModal(this);
                "
                class="inline"
              >
                {% csrf_token %}
                <button
                  type="submit"
                  class="text-gray-400 hover:text-red-600 transition-colors transform hover:scale-110"
                >
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-16">
      <div
        class="bg-gray-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"
      >
        <i data-lucide="search" class="w-10 h-10 text-gray-300"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">
        No expenses found
      </h3>
      <p class="mt-2 text-gray-500 dark:text-slate-400">
        You haven't added any expenses yet.
      </p>
      <div class="mt-6">
        <a
          href="{% url 'add_expense' %}"
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-indigo-700"
        >
          Add First Expense
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Download Format Modal -->
<div
  id="downloadModal"
  class="fixed inset-0 z-[100] hidden overflow-y-auto"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <div
    class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0"
  >
    <div
      class="fixed inset-0 transition-opacity bg-gray-500/75 backdrop-blur-sm"
      aria-hidden="true"
      onclick="closeDownloadModal()"
    ></div>

    <span
      class="hidden sm:inline-block sm:align-middle sm:h-screen"
      aria-hidden="true"
      >&#8203;</span
    >

    <div
      class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full border border-gray-100 dark:border-slate-800"
    >
      <div class="px-6 py-6" id="download-modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3
            class="text-xl font-bold text-gray-900 dark:text-white"
            id="modal-title"
          >
            Download Report
          </h3>
          <button
            onclick="closeDownloadModal()"
            class="text-gray-400 hover:text-gray-500 dark:text-slate-500 dark:hover:text-slate-400 transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <p class="text-sm text-gray-500 dark:text-slate-400 mb-6">
          Select your preferred file format to download your expense history
          report.
        </p>

        <div class="grid gap-4">
          <!-- PDF Option -->
          <a
            href="{% url 'export_expenses' 'pdf' %}"
            class="flex items-center p-4 rounded-xl border border-gray-200 dark:border-slate-800 hover:border-red-500 dark:hover:border-red-500/50 hover:bg-red-50/50 dark:hover:bg-red-900/10 transition-all group"
          >
            <div
              class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600 dark:text-red-400 mr-4"
            >
              <i data-lucide="file-text" class="w-5 h-5"></i>
            </div>
            <div class="flex-grow">
              <div class="text-sm font-bold text-gray-900 dark:text-white">
                PDF Document
              </div>
              <div class="text-xs text-gray-500 dark:text-slate-500">
                Professional report format
              </div>
            </div>
            <i
              data-lucide="chevron-right"
              class="w-4 h-4 text-gray-300 dark:text-slate-700 group-hover:text-red-500 transition-colors"
            ></i>
          </a>

          <!-- CSV Option -->
          <a
            href="{% url 'export_expenses' 'csv' %}"
            class="flex items-center p-4 rounded-xl border border-gray-200 dark:border-slate-800 hover:border-emerald-500 dark:hover:border-emerald-500/50 hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 transition-all group"
          >
            <div
              class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 mr-4"
            >
              <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
            </div>
            <div class="flex-grow">
              <div class="text-sm font-bold text-gray-900 dark:text-white">
                CSV Data
              </div>
              <div class="text-xs text-gray-500 dark:text-slate-500">
                Best for analysis and spreadsheets
              </div>
            </div>
            <i
              data-lucide="chevron-right"
              class="w-4 h-4 text-gray-300 dark:text-slate-700 group-hover:text-emerald-500 transition-colors"
            ></i>
          </a>

          <!-- Excel Option -->
          <a
            href="{% url 'export_expenses' 'excel' %}"
            class="flex items-center p-4 rounded-xl border border-gray-200 dark:border-slate-800 hover:border-blue-500 dark:hover:border-blue-500/50 hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-all group"
          >
            <div
              class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 mr-4"
            >
              <i data-lucide="file-box" class="w-5 h-5"></i>
            </div>
            <div class="flex-grow">
              <div class="text-sm font-bold text-gray-900 dark:text-white">
                Excel (MS File)
              </div>
              <div class="text-xs text-gray-500 dark:text-slate-500">
                Microsoft Excel Spreadsheet
              </div>
            </div>
            <i
              data-lucide="chevron-right"
              class="w-4 h-4 text-gray-300 dark:text-slate-700 group-hover:text-blue-500 transition-colors"
            ></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function openDownloadModal() {
    const modal = document.getElementById("downloadModal");
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";

    // Animate content
    const content = modal.querySelector(".inline-block");
    content.classList.add("scale-95", "opacity-0");
    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

    lucide.createIcons();
  }

  function closeDownloadModal() {
    const modal = document.getElementById("downloadModal");
    const content = modal.querySelector(".inline-block");
    content.classList.remove("scale-100", "opacity-100");
    content.classList.add("scale-95", "opacity-0");

    setTimeout(() => {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
    }, 200);
  }

  // Close modal on escape key
  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      closeDownloadModal();
    }
  });
</script>

{% endblock %}
